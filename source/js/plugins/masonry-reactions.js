(function(){function q(){try{localStorage.setItem(`${"masonry-reactions-viewer"}:${g}`,JSON.stringify(h))}catch{}}async function y(){const a=localStorage.getItem("giscus-session");if(!a)return null;let b;try{b=JSON.parse(a)}catch{return null}if(!b)return null;try{const c=await fetch("https://giscus.app/api/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(b)}`});return c.ok?(await c.json()).token||null:(console.warn("[masonry-reactions] Token exchange failed:",
c.status),null)}catch(c){return console.warn("[masonry-reactions] Token exchange error:",c),null}}async function z(a){if(!r||!t||!g)return null;try{const b=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({query:"\n      query($owner: String!, $name: String!, $number: Int!) {\n        repository(owner: $owner, name: $name) {\n          discussion(number: $number) {\n            comments(first: 100) {\n              nodes {\n                id\n                body\n                reactionGroups {\n                  content\n                  users { totalCount }\n                  viewerHasReacted\n                }\n              }\n            }\n          }\n        }\n      }\n    ",
variables:{owner:r,name:t,number:g}})});return b.ok?(await b.json()).data?.repository?.discussion?.comments?.nodes||null:null}catch(b){return console.warn("[masonry-reactions] Live fetch error:",b),null}}async function A(a,b,c){try{return(await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},body:JSON.stringify({query:`
      mutation($content: ReactionContent!, $subjectId: ID!) {
        toggleReaction: ${c?"remove":"add"}Reaction(input: {content: $content, subjectId: $subjectId}) {
          reaction { content, id }
        }
      }
    `,variables:{content:"HEART",subjectId:b}})})).ok}catch(d){return console.warn("[masonry-reactions] Toggle reaction error:",d),!1}}function B(a){return a?(a=a.match(/\x3c!-- masonry-image-id: (.+?) --\x3e/))?a[1].trim():null:null}function C(){document.querySelectorAll(".masonry-item .image-container").forEach(a=>{var b="",c=a.querySelector(".img-preloader");c&&(b=c.getAttribute("data-src")||"");b||(c=a.querySelector("img"))&&(b=c.getAttribute("data-src")||c.getAttribute("src")||"");if(b){a:{if(b){b=
decodeURIComponent(b.split("#")[0].split("?")[0]).replace(/\.[^.\/]+$/,"");for(d of Object.keys(f))if(c=d.replace(/\.[^.\/]+$/,""),b.includes(c)||b.endsWith(c))break a}var d=null}d&&(a.dataset.imageId=d,(c=f[d])?(b=document.createElement("button"),b.className="masonry-heart-btn",b.dataset.imageId=d,b.dataset.commentId=c.commentId,b.dataset.reacted="false",b.disabled=!0,b.setAttribute("aria-label","Like this photo"),b.innerHTML=`
      <span class="heart-icon">
        <i class="fa-regular fa-heart heart-outline"></i>
        <i class="fa-solid fa-heart heart-filled"></i>
      </span>
      <span class="heart-count">${c.heartCount||0}</span>
    `,0<c.heartCount&&b.classList.add("has-count"),b.addEventListener("click",D),d=b):d=null,d&&a.appendChild(d))}})}function l(a,b,c){if(a=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(a)}"]`)){var d=a.querySelector(".heart-count");d&&(d.textContent=String(b));a.dataset.reacted=c?"true":"false";a.classList.toggle("is-reacted",c);a.classList.toggle("has-count",0<b)}}function E(){document.querySelectorAll(".masonry-heart-btn").forEach(a=>{a.disabled=!1;a.classList.add("is-enabled")})}
async function D(a){a.preventDefault();a.stopPropagation();a=a.currentTarget;if(!a.disabled&&!a.classList.contains("is-loading"))if(m&&k){var b=a.dataset.imageId,c=a.dataset.commentId,d="true"===a.dataset.reacted;a.classList.add("is-loading");var e=parseInt(a.querySelector(".heart-count")?.textContent||"0")||0,u=!d;l(b,d?Math.max(0,e-1):e+1,u);var F=await A(k,c,d);a.classList.remove("is-loading");F?(h[c]=u,q()):l(b,e,d)}else G()}function G(){if(!document.querySelector(".masonry-login-prompt")){var a=
document.createElement("div");a.className="masonry-login-prompt";a.innerHTML='\n      <div class="masonry-login-prompt-content">\n        <i class="fa-brands fa-github"></i>\n        <span>Sign in with GitHub to like photos</span>\n        <button class="masonry-login-prompt-close" aria-label="Close">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n    ';document.body.appendChild(a);var b=setTimeout(()=>{a.classList.add("is-hiding");setTimeout(()=>a.remove(),300)},3E3);
a.querySelector(".masonry-login-prompt-close")?.addEventListener("click",()=>{clearTimeout(b);a.classList.add("is-hiding");setTimeout(()=>a.remove(),300)});requestAnimationFrame(()=>a.classList.add("is-visible"))}}function H(a){for(const c of a){a=B(c.body);if(!a)continue;var b=c.reactionGroups?.find(e=>"HEART"===e.content);if(!b)continue;const d=b.users?.totalCount||0;b=b.viewerHasReacted||!1;f[a]&&(f[a].heartCount=d);h[c.id]=b;l(a,d,b)}q()}function v(){for(const [a,b]of Object.entries(h))for(const [c,
d]of Object.entries(f))if(d.commentId===a){const e=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(c)}"]`);e&&b&&(e.dataset.reacted="true",e.classList.add("is-reacted"))}}async function n(a=0){try{if(k=await y()){m=!0;E();const b=await z(k);b&&H(b)}else 0===a&&(new URLSearchParams(location.search)).has("giscus")?setTimeout(()=>n(1),2E3):v()}catch(b){console.warn("[masonry-reactions] Auth error:",b),v()}}async function w(){C();await n()}const x=document.getElementById("masonry-reactions-data");
if(x){try{var p=JSON.parse(x.textContent||"")}catch(a){console.warn("[masonry-reactions] Failed to parse embedded data:",a);return}if(p&&p.imageReactions){var {repo:I,discussionNumber:g,imageReactions:f}=p,[r,t]=(I||"").split("/"),h=function(){try{const a=localStorage.getItem(`${"masonry-reactions-viewer"}:${g}`);return a?JSON.parse(a):{}}catch{return{}}}(),k=null,m=!1;window.addEventListener("storage",a=>{"giscus-session"===a.key&&a.newValue&&!m&&n()});"loading"===document.readyState?document.addEventListener("DOMContentLoaded",
w):w()}}})();

import{requestImageBySrc as e,transformPreloaderToImage as t,loadedPreloaders as n}from"../layouts/lazyload.js";export default function imageViewer(){const i=window.__REDEFINE_X_IMAGE_VIEWER__||(window.__REDEFINE_X_IMAGE_VIEWER__={docBound:!1,maskEl:null,stageEl:null,handlers:{},api:null}),a=document.querySelector(".image-viewer-container"),r=a?.querySelector(".image-viewer-stage"),o=a?.querySelector(".image-viewer-switcher"),s=o?.querySelector(".image-viewer-switcher-pages"),l=o?.querySelector(".image-viewer-switcher-btn.prev"),d=o?.querySelector(".image-viewer-switcher-btn.next"),c=a?.querySelector(".image-viewer-switcher-side.prev"),m=a?.querySelector(".image-viewer-switcher-side.next");if(!(a&&r&&o&&s&&l&&d&&c&&m))return;const h=360,g="cubic-bezier(0.22, 1, 0.36, 1)",p=(()=>{const e=document.createElement("img");e.alt="",e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",r.appendChild(e);const t=getComputedStyle(e),n={padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,borderRadius:t.borderRadius};return e.remove(),n})(),u=(()=>{const e=document.createElement("div");e.className="img-preloader image-viewer-img-preloader",e.style.position="fixed",e.style.left="-9999px",e.style.top="-9999px",e.style.width="200px",e.style.height="120px",e.innerHTML='<div class="img-preloader-skeleton"></div>',r.appendChild(e);const t=getComputedStyle(e),n={padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,borderRadius:t.borderRadius};return e.remove(),n})(),w={padding:p.padding,backgroundColor:p.backgroundColor,boxShadow:p.boxShadow},nextFrame=()=>new Promise((e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))})),f=".right-side-tools-container, .aplayer.aplayer-fixed";let y=null;const isViewableImg=e=>e&&!e.closest(".image-viewer-container")&&!e.hasAttribute("data-no-viewer"),isViewablePreloader=e=>e&&!e.closest(".image-viewer-container")&&e.classList.contains("img-preloader"),toAbsUrl=e=>{try{return new URL(e,window.location.href).href}catch{return String(e||"")}},x={isOpen:!1,isAnimating:!1,currentIndex:-1,items:[],contextRoot:null,activeImg:null,activeEl:null,articleOriginalNode:null,placeholder:null,saved:null,switcherShowTimer:null,scale:1,translateX:0,translateY:0,isDragging:!1,dragStartX:0,dragStartY:0,pointers:new Map,pinchStart:null,fixedHidden:!1},applyTransform=()=>x.activeImg&&(x.activeImg.style.transform=`translate(${x.translateX}px, ${x.translateY}px) scale(${x.scale})`),constrainVisible=()=>{if(!x.activeImg)return;const e=r.getBoundingClientRect(),t=x.activeImg.getBoundingClientRect(),n=.1*t.width,i=.1*t.height;t.right<e.left+n?x.translateX+=e.left+n-t.right:t.left>e.right-n&&(x.translateX+=e.right-n-t.left),t.bottom<e.top+i?x.translateY+=e.top+i-t.bottom:t.top>e.bottom-i&&(x.translateY+=e.bottom-i-t.top),applyTransform()},getViewerContentRect=()=>{const e=a.getBoundingClientRect(),t=getComputedStyle(a),n=parseFloat(t.paddingLeft||"0")||0,i=parseFloat(t.paddingRight||"0")||0,r=parseFloat(t.paddingTop||"0")||0,o=parseFloat(t.paddingBottom||"0")||0;return{left:e.left+n,top:e.top+r,width:Math.max(0,e.width-n-i),height:Math.max(0,e.height-r-o)}},computeViewerRect=e=>{const t=getViewerContentRect(),n=t.width-4,i=t.height-4,a=(e.naturalWidth||1)/(e.naturalHeight||1);let r=n,o=r/a;o>i&&(o=i,r=o*a);const s=r+4,l=o+4;return{left:t.left+(t.width-s)/2,top:t.top+(t.height-l)/2,width:s,height:l}},saveOriginal=e=>{const t=getComputedStyle(e),n=(e=>{const t=e.getBoundingClientRect();return{left:t.left,top:t.top,width:t.width,height:t.height}})(e);return{parent:e.parentNode,nextSibling:e.nextSibling,styleAttr:e.getAttribute("style"),borderRadius:t.borderRadius,padding:t.padding,backgroundColor:t.backgroundColor,boxShadow:t.boxShadow,rect:n}},restoreOriginal=(e,t)=>{const n=t||x.saved;n&&(null==n.styleAttr?e.removeAttribute("style"):e.setAttribute("style",n.styleAttr),e.classList.remove("img-preloader-loaded"),e.style.animation="")},v=1009,setFlightStyles=(e,t,n,i,a,r,o)=>{const s=n.left-t.left,l=n.top-t.top,d=n.width/t.width,c=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      border-radius:${a||"0"};\n      clip-path: inset(0 round ${a||"0"});\n      -webkit-clip-path: inset(0 round ${a||"0"});\n      box-sizing:border-box;\n      overflow:hidden;\n      padding:${i?.padding??"0"};\n      background-color:${i?.backgroundColor??"transparent"};\n      box-shadow:${i?.boxShadow??"none"};\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${o};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity,border-radius,box-shadow,padding; \n      transition:none;\n      transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n      animation:none;\n    `,e.classList.remove("img-preloader-loaded"),r.appendChild(e),e.offsetWidth},animateFlight=async(e,t,n,i)=>(await nextFrame(),await nextFrame(),e.style.transition=[`transform ${t}ms ${g}`,`box-shadow ${t}ms ${g}`,`background-color ${t}ms ${g}`,`padding ${t}ms ${g}`,`border-radius ${t}ms ${g}`].join(", "),e.style.transform="translate(0, 0) scale(1, 1)",n&&(null!=n.padding&&(e.style.padding=n.padding),null!=n.backgroundColor&&(e.style.backgroundColor=n.backgroundColor),null!=n.boxShadow&&(e.style.boxShadow=n.boxShadow)),null!=i&&(e.style.borderRadius=i),new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+100)}))),clearFlightStyles=(e,t)=>{const n=["position","left","top","width","height","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","animation"];t||n.push("borderRadius","clipPath","webkitClipPath","boxSizing","padding","backgroundColor","boxShadow"),n.forEach((t=>e.style[t]=""))},computeViewerRectFromAspect=e=>{const t=getViewerContentRect(),n=t.width-4,i=t.height-4,a=Number.isFinite(e)&&e>0?e:1;let r=n,o=r/a;o>i&&(o=i,r=o*a);const s=r+4,l=o+4;return{left:t.left+(t.width-s)/2,top:t.top+(t.height-l)/2,width:s,height:l}},getNodeAspectRatio=(e,t)=>{if(t&&t.width>0&&t.height>0)return t.width/t.height;if(e instanceof HTMLImageElement&&e.naturalWidth&&e.naturalHeight)return e.naturalWidth/e.naturalHeight;const n=e?.getBoundingClientRect?.();return n&&n.width>0&&n.height>0?n.width/n.height:1},createPlaceholderForNode=(e,t)=>{const n=document.createElement("span");n.className="image-viewer-placeholder";const i=getComputedStyle(e);return n.style.cssText=`\n      display:${i.display};\n      width:${i.width};\n      max-width:${i.maxWidth};\n      max-height:${i.maxHeight};\n      height:auto;\n      aspect-ratio:${t};\n      margin:${i.margin};\n      padding:0;\n      border:none;\n      visibility:hidden;\n      box-sizing:border-box;\n    `,n},createStagePreloader=(e,t)=>{const n=document.createElement("div");return n.className="img-preloader image-viewer-img-preloader",n.dataset.src="",n.dataset.width="0",n.dataset.height="0",n.style.width=`${e.width}px`,n.style.height=`${e.height}px`,n.style.aspectRatio=`${t}`,n.style.maxWidth="none",n.style.maxHeight="none",n.innerHTML='<div class="img-preloader-skeleton"></div>',n},setViewerPreloaderError=(e,t="")=>{if(!(e instanceof HTMLElement))return;e.classList.add("img-preloader-error");const n=e.querySelector(".img-preloader-skeleton");n&&(n.innerHTML=`\n      <i class="fa-solid fa-circle-xmark img-preloader-error-icon"></i>\n      <div class="img-preloader-error-text">\n        <div class="error-message">Failed to load image</div>\n        <div class="error-url">${t}</div>\n      </div>\n    `)},waitForImageReady=e=>new Promise(((t,n)=>{if(e.complete&&e.naturalWidth)return t(e);const onLoad=()=>cleanup(t,e),onErr=()=>cleanup(n,new Error("Image failed to load")),cleanup=(t,n)=>{e.removeEventListener("load",onLoad),e.removeEventListener("error",onErr),t(n)};e.addEventListener("load",onLoad),e.addEventListener("error",onErr)})),setGenericFlightStyles=(e,t,n,i)=>{const a=n.left-t.left,r=n.top-t.top,o=n.width/t.width,s=n.height/t.height;e.style.cssText=`\n      position:fixed;\n      left:${t.left}px;\n      top:${t.top}px;\n      width:${t.width}px;\n      height:${t.height}px;\n      margin:0;\n      max-width:none;\n      max-height:none;\n      z-index:${i};\n      pointer-events:none;\n      transform-origin:top left;\n      will-change:transform,opacity;\n      transition:none;\n      transform:translate(${a}px, ${r}px) scale(${o}, ${s});\n      opacity:1;\n      animation:none;\n      box-sizing:border-box;\n      overflow:hidden;\n      padding:${u.padding};\n      background-color:${u.backgroundColor};\n      border-radius:${u.borderRadius};\n      clip-path: inset(0 round ${u.borderRadius});\n      -webkit-clip-path: inset(0 round ${u.borderRadius});\n      box-shadow:${u.boxShadow};\n    `,document.body.appendChild(e),e.offsetWidth},clearFixedStylesKeepStageSize=e=>{["position","left","top","margin","maxWidth","maxHeight","zIndex","pointerEvents","transformOrigin","willChange","transition","transform","opacity","animation"].forEach((t=>{e.style[t]=""}))},onKeydown=e=>{x.isOpen&&("Escape"===e.key?close():"ArrowLeft"===e.key?navigate(-1):"ArrowRight"===e.key&&navigate(1))},getLiveNodeForItem=e=>{if(!x.contextRoot)return e.node;if("preloader"===e.kind){const t=Array.from(x.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc));if(t)return t;return Array.from(x.contextRoot.querySelectorAll(".img-preloader")).find((t=>toAbsUrl(t.dataset.src)===e.absSrc))||e.node}return Array.from(x.contextRoot.querySelectorAll("img")).find((t=>toAbsUrl(t.dataset.originalSrc||t.currentSrc||t.src)===e.absSrc))||e.node},updateSwitcher=()=>{s.innerHTML="";const e=x.items.length;if(e<=1)return void(s.style.display="none");const t=parseFloat(getComputedStyle(o).gap||"0")||0,n=parseFloat(getComputedStyle(s).gap||"0")||0,isVisible=e=>{if(!(e instanceof HTMLElement))return!1;const t=getComputedStyle(e);if("none"===t.display||"hidden"===t.visibility)return!1;const n=e.getBoundingClientRect();return n.width>0&&n.height>0},i=document.documentElement.clientWidth||window.innerWidth,a=Math.floor(.8*i),r=isVisible(l),c=isVisible(d),m=(r?l.getBoundingClientRect().width:0)+(c?d.getBoundingClientRect().width:0)+((r?1:0)+(c?1:0))*t,h=Math.max(0,a-m),g=Math.floor((h+n)/(38+n));if(g<3)return void(s.style.display="none");s.style.display="";const p=x.currentIndex+1;buildPaginationTokens(e,p,g).forEach((e=>{"ellipsis"===e?createEllipsis():createSwitcherBtn(e-1,e)})),updateSwitcherActive()},buildPaginationTokens=(e,t,n)=>{if(e<=n)return Array.from({length:e},((e,t)=>t+1));if(3===n){let n=Math.max(1,Math.min(t-1,e-2));return[n,n+1,n+2]}if(4===n)return t<=2?[1,2,3,"ellipsis"]:t>=e-1?["ellipsis",e-2,e-1,e]:["ellipsis",t-1,t,"ellipsis"];if(5===n)return t<=3?[1,2,3,4,"ellipsis"]:t>=e-2?["ellipsis",e-3,e-2,e-1,e]:["ellipsis",t-1,t,t+1,"ellipsis"];const i=n-2;if(t<=i-1){return[...Array.from({length:i},((e,t)=>t+1)),"ellipsis",e]}if(t>=e-(i-2)){const t=e-i+1;return[1,"ellipsis",...Array.from({length:i},((e,n)=>t+n))]}const a=i-2;let r=t-Math.floor(a/2),o=r+a-1;r<2&&(r=2,o=r+a-1),o>e-1&&(o=e-1,r=o-a+1);return[1,"ellipsis",...Array.from({length:a},((e,t)=>r+t)),"ellipsis",e]},createSwitcherBtn=(e,t)=>{const n=document.createElement("button");n.type="button",n.className="image-viewer-switcher-page",n.dataset.index=String(e),n.textContent=String(t),s.appendChild(n)},createEllipsis=()=>{const e=document.createElement("div");e.className="image-viewer-switcher-ellipsis",e.innerHTML='\n      <span class="dot"></span>\n      <span class="dot"></span>\n      <span class="dot"></span>\n    ',s.appendChild(e)},updateSwitcherActive=()=>{Array.from(s.children).forEach((e=>{if(!(e instanceof HTMLElement))return;const t=Number(e.dataset.index||"-1");e.classList.toggle("active",t===x.currentIndex)}));const e=s.querySelector(`.image-viewer-switcher-page[data-index="${x.currentIndex}"]`);e?.scrollIntoView?.({block:"nearest",inline:"center"})},hideSwitcher=()=>{x.switcherShowTimer&&(clearTimeout(x.switcherShowTimer),x.switcherShowTimer=null),o.classList.remove("shown"),c.classList.remove("shown"),m.classList.remove("shown")},scheduleShowSwitcher=()=>{x.switcherShowTimer&&clearTimeout(x.switcherShowTimer),x.switcherShowTimer=setTimeout((()=>{x.switcherShowTimer=null,x.isOpen&&!x.isAnimating&&(o.classList.add("shown"),c.classList.add("shown"),m.classList.add("shown"))}),300)},mountLoadedImgToStage=e=>{r.innerHTML="",e.classList.remove("img-preloader-loaded"),e.style.animation="",r.appendChild(e),x.activeImg=e,x.activeEl=e,e.style.cursor="grab",e.style.touchAction="none",e.style.width="",e.style.height="",applyTransform(),constrainVisible()},mountPreloaderToStage=e=>{r.innerHTML="",r.appendChild(e),x.activeImg=null,x.activeEl=e},openItemAtIndex=async(i,a)=>{const r=x.items[i];if(!r)return;const o=getLiveNodeForItem(r),s=getNodeAspectRatio(o,r),l=o instanceof HTMLImageElement&&o.naturalWidth&&o.naturalHeight?computeViewerRect(o):computeViewerRectFromAspect(s);if(x.scale=1,x.translateX=x.translateY=0,x.pointers.clear(),x.pinchStart=null,x.isDragging=!1,o instanceof HTMLImageElement){if(x.saved=saveOriginal(o),x.articleOriginalNode=o,x.placeholder=createPlaceholderForNode(o,s),o.before(x.placeholder),setFlightStyles(o,l,x.saved.rect,w,p.borderRadius,document.body,v),await animateFlight(o,420,w,p.borderRadius),clearFlightStyles(o,!0),o.complete&&o.naturalWidth)return void mountLoadedImgToStage(o);const e=createStagePreloader(l,s);return mountPreloaderToStage(e),o.remove(),void waitForImageReady(o).then((async()=>{if(x.isOpen){try{await o.decode()}catch{}await nextFrame(),e.remove(),mountLoadedImgToStage(o),o.style.opacity="0",await nextFrame(),o.style.transition=`opacity 220ms ${g}`,o.style.opacity="1"}})).catch((()=>{setViewerPreloaderError(e,r.src)}))}if(o instanceof HTMLElement&&o.classList.contains("img-preloader")){const i=o.getBoundingClientRect();x.articleOriginalNode=o,x.saved={rect:{left:i.left,top:i.top,width:i.width,height:i.height}},x.placeholder=createPlaceholderForNode(o,s),o.replaceWith(x.placeholder);const a=o.cloneNode(!0);a.classList.add("image-viewer-img-preloader"),a.classList.remove("img-preloader-fade-out","img-preloader-loaded","img-preloader-error"),a.style.opacity="1",a.style.width=`${l.width}px`,a.style.height=`${l.height}px`,a.style.aspectRatio=`${s}`,setGenericFlightStyles(a,l,x.saved.rect,v),await(async(e,t)=>(await nextFrame(),await nextFrame(),e.style.transition=`transform ${t}ms ${g}, opacity ${t}ms ${g}`,e.style.transform="translate(0, 0) scale(1, 1)",new Promise((n=>{let i=!1;const finish=()=>{i||(i=!0,e.removeEventListener("transitionend",onEnd),n())},onEnd=t=>t.target===e&&"transform"===t.propertyName&&finish();e.addEventListener("transitionend",onEnd),setTimeout(finish,t+80)}))))(a,420),clearFixedStylesKeepStageSize(a),mountPreloaderToStage(a),e(r.src,r.alt).then((async e=>{if(!x.isOpen)return;try{await e.decode()}catch{}const i=e;t(o,i),i.classList.remove("img-preloader-fade-out"),x.articleOriginalNode=i,n.add(o),a.remove(),mountLoadedImgToStage(i),i.style.opacity="0",await nextFrame(),i.style.transition=`opacity 220ms ${g}`,i.style.opacity="1"})).catch((()=>{setViewerPreloaderError(a,r.src)}))}};async function close(){if(!x.isOpen||x.isAnimating)return;if(!x.activeEl||!x.placeholder)return;x.isAnimating=!0,document.removeEventListener("keydown",onKeydown),x.resizeHandler&&(window.removeEventListener("resize",x.resizeHandler),x.resizeHandler=null),x.resizeTimer&&(clearTimeout(x.resizeTimer),x.resizeTimer=null),hideSwitcher(),a.classList.remove("switching");const e=x.activeEl,t=x.placeholder;if(x.articleOriginalNode instanceof HTMLImageElement&&e===x.articleOriginalNode){const n=e,i=getComputedStyle(n),o=n.getBoundingClientRect(),s=t.getBoundingClientRect(),l={left:s.left,top:s.top,width:s.width,height:s.height},d=o.left-l.left,c=o.top-l.top,m=o.width/l.width,g=o.height/l.height,p={padding:x.saved?.padding??"0",backgroundColor:x.saved?.backgroundColor??"transparent",boxShadow:x.saved?.boxShadow??"none"};a.style.zIndex=String(1003),n.style.cssText=`\n        position:fixed;\n        left:${l.left}px;\n        top:${l.top}px;\n        width:${l.width}px;\n        height:${l.height}px;\n        border-radius:${i.borderRadius};\n        box-sizing:border-box;\n        padding:${i.padding};\n        background-color:${i.backgroundColor};\n        box-shadow:${i.boxShadow};\n        margin:0;\n        max-width:none;\n        max-height:none;\n        z-index:1004;\n        pointer-events:none;\n        transform-origin:top left;\n        will-change:transform,opacity;\n        transition:none;\n        transform:translate(${d}px, ${c}px) scale(${m}, ${g});\n        animation:none;\n      `,n.classList.remove("img-preloader-loaded"),document.body.appendChild(n),r.innerHTML="",a.classList.remove("active"),await animateFlight(n,h,p,x.saved?.borderRadius),clearFlightStyles(n,!1),restoreOriginal(n,x.saved),t.replaceWith(n)}else{const n=e.getBoundingClientRect(),i=t.getBoundingClientRect(),o={left:i.left,top:i.top,width:i.width,height:i.height},s=n.left-o.left,l=n.top-o.top,d=n.width/o.width,c=n.height/o.height;if(e.classList.contains("image-viewer-img-preloader")||e.classList.contains("img-preloader")){if(a.classList.remove("active"),e.style.transition=`opacity 360ms ${g}`,e.style.opacity="0",await new Promise((e=>setTimeout(e,h))),e.remove(),x.articleOriginalNode instanceof HTMLElement){const e=x.articleOriginalNode;t.replaceWith(e),e.style.opacity="0",e.animate([{opacity:0},{opacity:1}],{duration:220,easing:"ease-out",fill:"forwards"}),setTimeout((()=>{e.isConnected&&(e.style.opacity="")}),220)}}else{a.style.zIndex=String(1003);const n=getComputedStyle(e);e.style.cssText=`\n            position:fixed;\n            left:${o.left}px;\n            top:${o.top}px;\n            width:${o.width}px;\n            height:${o.height}px;\n            border-radius:${n.borderRadius};\n            box-sizing:border-box;\n            padding:${n.padding};\n            background-color:${n.backgroundColor};\n            box-shadow:${n.boxShadow};\n            margin:0;\n            max-width:none;\n            max-height:none;\n            z-index:1004;\n            pointer-events:none;\n            transform-origin:top left;\n            will-change:transform,opacity;\n            transition:none;\n            transform:translate(${s}px, ${l}px) scale(${d}, ${c});\n            opacity:1;\n            animation:none;\n          `,document.body.appendChild(e),r.innerHTML="",a.classList.remove("active"),await nextFrame(),await nextFrame(),e.style.transition=`transform 360ms ${g}, opacity 360ms ${g}`,e.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,440))),e.remove(),x.articleOriginalNode instanceof HTMLElement&&t.replaceWith(x.articleOriginalNode)}}document.documentElement.style.overflow="",x.fixedHidden&&(((e=300)=>{y=setTimeout((()=>{document.querySelectorAll(f).forEach((e=>{e.classList.remove("hide")})),y=null}),e)})(300),x.fixedHidden=!1),x.activeImg=x.activeEl=null,x.articleOriginalNode=null,x.placeholder=null,x.saved=null,x.pointers.clear(),x.pinchStart=null,x.isOpen=x.isAnimating=!1,a.style.zIndex=""}async function navigate(e){if(!x.isOpen||x.items.length<=1||x.isAnimating)return;const t=(x.currentIndex+e+x.items.length)%x.items.length;await switchToIndex(t)}async function switchToIndex(i){if(!x.isOpen||x.isAnimating)return;if(i===x.currentIndex)return;const o=x.items[i];if(!o)return;const s=i>x.currentIndex?-1:1,l=420,d=Math.round(210);x.isAnimating=!0,hideSwitcher(),a.classList.add("switching");const c=x.activeEl,m=x.placeholder,h=x.articleOriginalNode,u=x.saved,f=c.getBoundingClientRect();r.innerHTML="",c instanceof HTMLImageElement?setFlightStyles(c,f,f,w,p.borderRadius,document.body,v):setGenericFlightStyles(c,f,f,v);const y=window.innerWidth,b=window.innerHeight/2-(f.top+f.height/2),$=s<0?-(f.left+f.width+40):y-f.left+40;await nextFrame(),await nextFrame(),c.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,c.style.transform=`translate(${$}px, ${b}px) scale(0.6, 0.6)`,c.style.opacity="0",setTimeout((async()=>{if(!x.isOpen)return;x.currentIndex=i,updateSwitcher();const a=getLiveNodeForItem(o),r=getNodeAspectRatio(a,o),l=a instanceof HTMLImageElement&&a.naturalWidth&&a.naturalHeight?computeViewerRect(a):computeViewerRectFromAspect(r);let d;if(x.scale=1,x.translateX=x.translateY=0,x.pointers.clear(),x.pinchStart=null,x.isDragging=!1,a instanceof HTMLImageElement){if(x.saved=saveOriginal(a),x.articleOriginalNode=a,x.placeholder=createPlaceholderForNode(a,r),a.before(x.placeholder),d=a,setFlightStyles(d,l,l,w,p.borderRadius,document.body,v),d.style.transform=s<0?`translate(${y-l.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(l.left+l.width+40)}px, 0px) scale(0.6, 0.6)`,d.style.opacity="0",await nextFrame(),d.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,d.style.opacity="1",d.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFlightStyles(d,!0),mountLoadedImgToStage(d),!d.complete||!d.naturalWidth){const e=createStagePreloader(l,r);mountPreloaderToStage(e),d.remove(),waitForImageReady(d).then((async()=>{if(x.isOpen&&x.currentIndex===i){try{await d.decode()}catch{}await nextFrame(),e.remove(),mountLoadedImgToStage(d),d.style.opacity="0",await nextFrame(),d.style.transition=`opacity 220ms ${g}`,d.style.opacity="1"}})).catch((()=>{setViewerPreloaderError(e,o.src)}))}}else if(a instanceof HTMLElement&&a.classList.contains("img-preloader")){const d=a.getBoundingClientRect();x.articleOriginalNode=a,x.saved={rect:{left:d.left,top:d.top,width:d.width,height:d.height}},x.placeholder=createPlaceholderForNode(a,r),a.replaceWith(x.placeholder);const c=createStagePreloader(l,r);setGenericFlightStyles(c,l,l,v),c.style.transform=s<0?`translate(${y-l.left+40}px, 0px) scale(0.6, 0.6)`:`translate(${-(l.left+l.width+40)}px, 0px) scale(0.6, 0.6)`,c.style.opacity="0",await nextFrame(),c.style.transition=`transform 420ms ${g}, opacity 420ms ${g}`,c.style.opacity="1",c.style.transform="translate(0, 0) scale(1, 1)",await new Promise((e=>setTimeout(e,500))),clearFixedStylesKeepStageSize(c),mountPreloaderToStage(c),e(o.src,o.alt).then((async e=>{if(!x.isOpen||x.currentIndex!==i)return;try{await e.decode()}catch{}const r=e;t(a,r),r.classList.remove("img-preloader-fade-out"),x.articleOriginalNode=r,n.add(a),c.remove(),mountLoadedImgToStage(r),r.style.opacity="0",await nextFrame(),r.style.transition=`opacity 220ms ${g}`,r.style.opacity="1"})).catch((()=>{setViewerPreloaderError(c,o.src)}))}const c=x.placeholder;if(c){const e=c.getBoundingClientRect().top+window.scrollY,t=Math.max(0,e-.2*window.innerHeight);try{window.scrollTo({top:t,behavior:"smooth"})}catch{window.scrollTo(0,t)}}}),d),setTimeout((()=>{h instanceof HTMLImageElement?(clearFlightStyles(c,!1),restoreOriginal(h,u),m?.replaceWith(h),h.classList.add("image-viewer-article-fade-in"),setTimeout((()=>h.classList.remove("image-viewer-article-fade-in")),260)):h instanceof HTMLElement?(c.remove(),m?.replaceWith(h),h.classList.add("image-viewer-article-fade-in"),setTimeout((()=>h.classList.remove("image-viewer-article-fade-in")),260)):c.remove()}),l),await new Promise((e=>setTimeout(e,l+d+120))),a.classList.remove("switching"),x.isAnimating=!1,scheduleShowSwitcher()}if(i.api={open:async function open(e){if(x.isOpen||x.isAnimating)return;x.isOpen=x.isAnimating=!0;const t=e instanceof HTMLElement?e.closest(".img-preloader")||e:null;x.contextRoot=(e=>{if(!e)return document;const t=e.closest?.(".markdown-body");if(t)return t;const n=e.closest?.("#shuoshuo-content");if(n)return n;const i=e.closest?.(".masonry-item");return i&&i.parentElement||document})(t),x.items=(e=>{const t=Array.from((e||document).querySelectorAll(".markdown-body img, .markdown-body .img-preloader, .masonry-item img, .masonry-item .img-preloader, #shuoshuo-content img, #shuoshuo-content .img-preloader")),n=[];return t.forEach((e=>{if(e instanceof HTMLImageElement){if(!isViewableImg(e))return;const t=e.dataset.originalSrc||e.currentSrc||e.src;n.push({kind:"img",node:e,src:String(t||""),absSrc:toAbsUrl(t),alt:e.alt||"",width:e.naturalWidth||0,height:e.naturalHeight||0})}else if(e instanceof HTMLElement&&isViewablePreloader(e)){if(e.classList.contains("img-preloader-error"))return;const t=e.dataset.src;if(!t)return;const i=Number(e.dataset.width||0),a=Number(e.dataset.height||0);n.push({kind:"preloader",node:e,src:String(t),absSrc:toAbsUrl(t),alt:e.dataset.alt||"",width:Number.isFinite(i)?i:0,height:Number.isFinite(a)?a:0})}})),n})(x.contextRoot),x.currentIndex=((e,t)=>{const n=e.findIndex((e=>e.node===t));if(n>=0)return n;if(t instanceof HTMLImageElement){const n=t.dataset.originalSrc||t.currentSrc||t.src,i=toAbsUrl(n);return e.findIndex((e=>e.absSrc===i))}const i=t?.closest?.(".img-preloader");if(i instanceof HTMLElement){const t=i.dataset.src,n=toAbsUrl(t);return e.findIndex((e=>e.absSrc===n))}return-1})(x.items,t),x.currentIndex<0||t instanceof HTMLElement&&t.classList.contains("img-preloader")&&!t.classList.contains("img-preloader-loaded")?x.isOpen=x.isAnimating=!1:(document.documentElement.style.overflow="hidden",x.fixedHidden=window.matchMedia&&window.matchMedia("(max-width: 768px), (pointer: coarse)").matches,x.fixedHidden&&(y&&(clearTimeout(y),y=null),document.querySelectorAll(f).forEach((e=>{e.classList.add("hide")}))),r.innerHTML="",a.style.zIndex="",a.classList.remove("switching"),a.classList.add("active"),hideSwitcher(),updateSwitcher(),await openItemAtIndex(x.currentIndex),x.isAnimating=!1,document.addEventListener("keydown",onKeydown),x.resizeHandler||(x.resizeHandler=()=>{x.isOpen&&(x.resizeTimer&&clearTimeout(x.resizeTimer),x.resizeTimer=setTimeout((()=>{x.resizeTimer=null,updateSwitcher()}),120))},window.addEventListener("resize",x.resizeHandler,{passive:!0})),scheduleShowSwitcher())},close:close,isOpen:()=>x.isOpen},l.onclick=()=>navigate(-1),d.onclick=()=>navigate(1),c.onclick=()=>navigate(-1),m.onclick=()=>navigate(1),s.onclick=e=>{if(!x.isOpen||x.isAnimating)return;const t=e.target?.closest?.(".image-viewer-switcher-page");if(!(t instanceof HTMLElement))return;const n=Number(t.dataset.index||"-1");!Number.isFinite(n)||n<0||n>=x.items.length||switchToIndex(n)},i.docBound||(i.handlers.onDocClick=e=>{const t=i.api;if(!t||t.isOpen())return;const n=e.target;if(n instanceof HTMLImageElement){if(!n.matches(".markdown-body img, .masonry-item img, #shuoshuo-content img")||!isViewableImg(n))return;return void t.open(n)}const a=n?.closest?.(".img-preloader");a instanceof HTMLElement&&isViewablePreloader(a)&&a.closest(".markdown-body, .masonry-item, #shuoshuo-content")&&t.open(a)},document.addEventListener("click",i.handlers.onDocClick,!0),i.docBound=!0),i.maskEl!==a&&(i.maskEl&&i.handlers.onMaskClick&&i.maskEl.removeEventListener("click",i.handlers.onMaskClick,!1),i.handlers.onMaskClick=e=>{x.isOpen&&!x.isDragging&&(e.target!==a&&e.target!==r||close())},a.addEventListener("click",i.handlers.onMaskClick,!1),i.maskEl=a),i.stageEl!==r){const e=i.stageEl;e&&["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((t=>{const n=i.handlers[`on${t}`];n&&e.removeEventListener(t,n,!1)})),i.handlers.onwheel=e=>{if(!x.isOpen||!x.activeImg||e.target!==x.activeImg)return;e.preventDefault();const t=x.activeImg.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2,a=x.scale;x.scale=Math.max(.5,Math.min(6,a*(e.deltaY>0?.9:1.1)));const r=x.scale/a-1;x.translateX-=n*r,x.translateY-=i*r,x.activeImg.style.transition="none",applyTransform(),constrainVisible()},i.handlers.onpointerdown=e=>{x.isOpen&&x.activeImg&&e.target===x.activeImg&&(e.preventDefault(),x.activeImg.setPointerCapture(e.pointerId),x.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===x.pointers.size&&(x.dragStartX=e.clientX-x.translateX,x.dragStartY=e.clientY-x.translateY,x.activeImg.style.cursor="grabbing",x.activeImg.style.transition="none"))},i.handlers.onpointermove=e=>{if(x.isOpen&&x.activeImg&&x.pointers.has(e.pointerId)){if(x.pointers.set(e.pointerId,{x:e.clientX,y:e.clientY}),1===x.pointers.size)return x.translateX=e.clientX-x.dragStartX,x.translateY=e.clientY-x.dragStartY,x.isDragging=!0,applyTransform(),void constrainVisible();if(2===x.pointers.size){const e=Array.from(x.pointers.values()),t=Math.hypot(e[0].x-e[1].x,e[0].y-e[1].y),n=(e[0].x+e[1].x)/2,i=(e[0].y+e[1].y)/2;x.pinchStart||(x.pinchStart={dist:t,midX:n,midY:i,scale:x.scale,tx:x.translateX,ty:x.translateY});const a=Math.max(.5,Math.min(6,x.pinchStart.scale*(t/x.pinchStart.dist))),r=a/x.scale,o=x.activeImg.getBoundingClientRect(),s=n-(o.left+o.width/2),l=i-(o.top+o.height/2);x.translateX-=s*(r-1),x.translateY-=l*(r-1),x.scale=a,x.isDragging=!0,applyTransform(),constrainVisible()}}},i.handlers.onpointerup=i.handlers.onpointercancel=e=>{if(x.isOpen&&x.activeImg)if(x.pointers.delete(e.pointerId),0===x.pointers.size)x.activeImg.style.cursor="grab",x.pinchStart=null,constrainVisible(),setTimeout((()=>x.isDragging=!1),50);else if(1===x.pointers.size){x.pinchStart=null;const e=Array.from(x.pointers.values())[0];x.dragStartX=e.x-x.translateX,x.dragStartY=e.y-x.translateY}},["wheel","pointerdown","pointermove","pointerup","pointercancel"].forEach((e=>{r.addEventListener(e,i.handlers[`on${e}`],{passive:!1})})),i.stageEl=r}}
//# sourceMappingURL=imageViewer.js.map
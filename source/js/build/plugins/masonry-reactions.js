!function(){function q(){try{localStorage.setItem(`masonry-reactions-viewer:${o}`,JSON.stringify(c))}catch{}}function B(e){return e&&(e=e.match(/\x3c!-- masonry-image-id: (.+?) --\x3e/))?e[1].trim():null}function l(e,t,a){if(e=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(e)}"]`)){var o=e.querySelector(".heart-count");o&&(o.textContent=String(t)),e.dataset.reacted=a?"true":"false",e.classList.toggle("is-reacted",a),e.classList.toggle("has-count",0<t)}}async function D(e){if(e.preventDefault(),e.stopPropagation(),!(e=e.currentTarget).disabled&&!e.classList.contains("is-loading"))if(u&&d){var t=e.dataset.imageId,a=e.dataset.commentId,o="true"===e.dataset.reacted;e.classList.add("is-loading");var r=parseInt(e.querySelector(".heart-count")?.textContent||"0")||0,s=!o;l(t,o?Math.max(0,r-1):r+1,s);var i=await async function A(e,t,a){try{return(await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({query:`\n      mutation($content: ReactionContent!, $subjectId: ID!) {\n        toggleReaction: ${a?"remove":"add"}Reaction(input: {content: $content, subjectId: $subjectId}) {\n          reaction { content, id }\n        }\n      }\n    `,variables:{content:"HEART",subjectId:t}})})).ok}catch(e){return console.warn("[masonry-reactions] Toggle reaction error:",e),!1}}(d,a,o);e.classList.remove("is-loading"),i?(c[a]=s,q()):l(t,r,o)}else!function G(){if(!document.querySelector(".masonry-login-prompt")){var e=document.createElement("div");e.className="masonry-login-prompt",e.innerHTML='\n      <div class="masonry-login-prompt-content">\n        <i class="fa-brands fa-github"></i>\n        <span>Sign in with GitHub to like photos</span>\n        <button class="masonry-login-prompt-close" aria-label="Close">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n    ',document.body.appendChild(e);var t=setTimeout((()=>{e.classList.add("is-hiding"),setTimeout((()=>e.remove()),300)}),3e3);e.querySelector(".masonry-login-prompt-close")?.addEventListener("click",(()=>{clearTimeout(t),e.classList.add("is-hiding"),setTimeout((()=>e.remove()),300)})),requestAnimationFrame((()=>e.classList.add("is-visible")))}}()}function v(){for(const[e,t]of Object.entries(c))for(const[a,o]of Object.entries(r))if(o.commentId===e){const e=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(a)}"]`);e&&t&&(e.dataset.reacted="true",e.classList.add("is-reacted"))}}async function n(e=0){try{if(d=await async function y(){const e=localStorage.getItem("giscus-session");if(!e)return null;let t;try{t=JSON.parse(e)}catch{return null}if(!t)return null;try{const e=await fetch("https://giscus.app/api/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(t)}`});return e.ok?(await e.json()).token||null:(console.warn("[masonry-reactions] Token exchange failed:",e.status),null)}catch(e){return console.warn("[masonry-reactions] Token exchange error:",e),null}}()){u=!0,function E(){document.querySelectorAll(".masonry-heart-btn").forEach((e=>{e.disabled=!1,e.classList.add("is-enabled")}))}();const e=await async function z(e){if(!s||!i||!o)return null;try{const t=await fetch("https://api.github.com/graphql",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({query:"\n      query($owner: String!, $name: String!, $number: Int!) {\n        repository(owner: $owner, name: $name) {\n          discussion(number: $number) {\n            comments(first: 100) {\n              nodes {\n                id\n                body\n                reactionGroups {\n                  content\n                  users { totalCount }\n                  viewerHasReacted\n                }\n              }\n            }\n          }\n        }\n      }\n    ",variables:{owner:s,name:i,number:o}})});return t.ok&&(await t.json()).data?.repository?.discussion?.comments?.nodes||null}catch(e){return console.warn("[masonry-reactions] Live fetch error:",e),null}}(d);e&&function H(e){for(const a of e){if(!(e=B(a.body)))continue;var t=a.reactionGroups?.find((e=>"HEART"===e.content));if(!t)continue;const o=t.users?.totalCount||0;t=t.viewerHasReacted||!1,r[e]&&(r[e].heartCount=o),c[a.id]=t,l(e,o,t)}q()}(e)}else 0===e&&new URLSearchParams(location.search).has("giscus")?setTimeout((()=>n(1)),2e3):v()}catch(e){console.warn("[masonry-reactions] Auth error:",e),v()}}async function w(){!function C(){document.querySelectorAll(".masonry-item .image-container").forEach((e=>{var t="",a=e.querySelector(".img-preloader");if(a&&(t=a.getAttribute("data-src")||""),t||(a=e.querySelector("img"))&&(t=a.getAttribute("data-src")||a.getAttribute("src")||""),t){e:{if(t)for(o of(t=decodeURIComponent(t.split("#")[0].split("?")[0]).replace(/\.[^.\/]+$/,""),Object.keys(r)))if(a=o.replace(/\.[^.\/]+$/,""),t.includes(a)||t.endsWith(a))break e;var o=null}o&&(e.dataset.imageId=o,(a=r[o])?((t=document.createElement("button")).className="masonry-heart-btn",t.dataset.imageId=o,t.dataset.commentId=a.commentId,t.dataset.reacted="false",t.disabled=!0,t.setAttribute("aria-label","Like this photo"),t.innerHTML=`\n      <span class="heart-icon">\n        <i class="fa-regular fa-heart heart-outline"></i>\n        <i class="fa-solid fa-heart heart-filled"></i>\n      </span>\n      <span class="heart-count">${a.heartCount||0}</span>\n    `,0<a.heartCount&&t.classList.add("has-count"),t.addEventListener("click",D),o=t):o=null,o&&e.appendChild(o))}}))}(),await n()}const e=document.getElementById("masonry-reactions-data");if(e){try{var t=JSON.parse(e.textContent||"")}catch(e){return void console.warn("[masonry-reactions] Failed to parse embedded data:",e)}if(t&&t.imageReactions){var{repo:a,discussionNumber:o,imageReactions:r}=t,[s,i]=(a||"").split("/"),c=function(){try{const e=localStorage.getItem(`masonry-reactions-viewer:${o}`);return e?JSON.parse(e):{}}catch{return{}}}(),d=null,u=!1;window.addEventListener("storage",(e=>{"giscus-session"===e.key&&e.newValue&&!u&&n()})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w):w()}}}();
//# sourceMappingURL=masonry-reactions.js.map
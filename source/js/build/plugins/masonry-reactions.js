(function(){const GISCUS_SESSION_KEY="giscus-session",GISCUS_ORIGIN="https://giscus.app",GITHUB_GRAPHQL_API="https://api.github.com/graphql",CACHE_KEY_PREFIX="masonry-reactions-cache:",CACHE_TTL=3e5;let currentPagePath="",imageReactions={},userToken=null,isAuthenticated=!1,isInitialized=!1,swupHooked=!1;function getPageConfig(){const e=document.getElementById("masonry-reactions-data");if(!e)return null;try{return JSON.parse(e.textContent||"")}catch{return null}}async function getGiscusToken(){const e=localStorage.getItem(GISCUS_SESSION_KEY);if(!e)return null;let t;try{t=JSON.parse(e)}catch{return null}if(!t)return null;try{const e=await fetch(`${GISCUS_ORIGIN}/api/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(t)}`});return e.ok&&(await e.json()).token||null}catch{return null}}function getGiscusLoginUrl(){const e=encodeURIComponent(location.href);return`${GISCUS_ORIGIN}/api/oauth/authorize?redirect_uri=${e}`}async function fetchFromGiscusAPI(e,t,n,a=100,o){const i=new URLSearchParams({repo:e,term:t,category:n,number:"0",strict:"false",first:String(a)});o&&i.set("after",o);try{const e=await fetch(`${GISCUS_ORIGIN}/api/discussions?${i}`);return e.ok?await e.json():(404===e.status||console.warn("[masonry-reactions] Giscus API error:",e.status),null)}catch(e){return console.warn("[masonry-reactions] Giscus API fetch error:",e),null}}async function fetchAllComments(e,t,n){const a=await fetchFromGiscusAPI(e,t,n,100);if(!a?.discussion)return null;const o=[...a.discussion.comments||[]];let i=a.discussion.pageInfo;for(;i?.hasNextPage&&i.endCursor;){const a=await fetchFromGiscusAPI(e,t,n,100,i.endCursor);if(!a?.discussion)break;o.push(...a.discussion.comments||[]),i=a.discussion.pageInfo}return o}async function checkViewerReactions(e,t){if(0===e.length)return{};const n={};for(let a=0;a<e.length;a+=50){const o=e.slice(a,a+50),i=o.map(((e,t)=>`c${t}: node(id: "${e}") { ... on DiscussionComment { id reactionGroups { content viewerHasReacted } } }`)).join("\n");try{const e=await fetch(GITHUB_GRAPHQL_API,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({query:`query { ${i} }`})});if(!e.ok)continue;const a=await e.json();if(a.errors)continue;for(let e=0;e<o.length;e++){const t=a.data?.[`c${e}`];if(t?.reactionGroups){const a=t.reactionGroups.find((e=>"HEART"===e.content));n[o[e]]=a?.viewerHasReacted||!1}}}catch{}}return n}async function toggleHeartReaction(e,t,n){const a=n?"remove":"add";try{return(await fetch(GITHUB_GRAPHQL_API,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({query:`mutation($content: ReactionContent!, $subjectId: ID!) {\n            toggleReaction: ${a}Reaction(input: {content: $content, subjectId: $subjectId}) {\n              reaction { content }\n            }\n          }`,variables:{content:"HEART",subjectId:t}})})).ok}catch{return!1}}function parseImageId(e){if(!e)return null;const t=e.match(/<code[^>]*>masonry-image:(.+?)<\/code>/);return t?t[1].trim():null}function getCacheKey(e){return`${CACHE_KEY_PREFIX}${e}`}function getCache(e){try{const t=sessionStorage.getItem(getCacheKey(e));if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>CACHE_TTL?(sessionStorage.removeItem(getCacheKey(e)),null):n}catch{return null}}function setCache(e,t){try{sessionStorage.setItem(getCacheKey(e),JSON.stringify(t))}catch{}}function clearCache(e){try{sessionStorage.removeItem(getCacheKey(e))}catch{}}function createHeartButton(e){const t=document.createElement("button");return t.className="masonry-heart-btn",t.dataset.imageId=e,t.setAttribute("aria-label","Like this photo"),t.innerHTML='\n      <span class="heart-icon">\n        <i class="fa-regular fa-heart heart-outline"></i>\n        <i class="fa-solid fa-heart heart-filled"></i>\n      </span>\n      <span class="heart-count">0</span>\n    ',t.addEventListener("click",handleHeartClick),t}function initializeHeartButtons(e){const t=document.querySelectorAll(".masonry-item .image-container"),n=new Set(e);t.forEach((e=>{if(e.querySelector(".masonry-heart-btn"))return;let t="";const a=e.querySelector(".img-preloader");if(a&&(t=a.getAttribute("data-src")||""),!t){const n=e.querySelector("img");n&&(t=n.getAttribute("data-src")||n.getAttribute("src")||"")}if(!t)return;const o=findImageIdFromSrc(t,n);o&&(e.dataset.imageId=o,e.classList.contains("masonry-reactions-mode")||e.classList.add("masonry-reactions-mode"),e.appendChild(createHeartButton(o)))}))}function findImageIdFromSrc(e,t){if(!e)return null;const n=decodeURIComponent(e.split("#")[0].split("?")[0]).replace(/\.[^.\/]+$/,"");for(const e of t){const t=e.replace(/\.[^.\/]+$/,"");if(n.includes(t)||n.endsWith(t))return e}return null}function updateHeartButton(e,t,n){const a=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(e)}"]`);if(!a)return;const o=a.querySelector(".heart-count");o&&(o.textContent=String(t)),a.dataset.reacted=n?"true":"false",a.classList.toggle("is-reacted",n),a.classList.toggle("has-count",t>0)}function applyReactions(e){imageReactions={};for(const t of e){const e=parseImageId(t.bodyHTML);if(!e)continue;const n=t.reactions?.HEART?.count||0,a=t.reactions?.HEART?.viewerHasReacted||!1;imageReactions[e]={commentId:t.id,heartCount:n,viewerHasReacted:a},updateHeartButton(e,n,a)}}function applyCachedReactions(e){imageReactions={...e.imageReactions};for(const[e,t]of Object.entries(imageReactions))updateHeartButton(e,t.heartCount,t.viewerHasReacted)}async function handleHeartClick(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;if(t.classList.contains("is-loading"))return;if(!isAuthenticated||!userToken)return void(window.location.href=getGiscusLoginUrl());const n=t.dataset.imageId,a=imageReactions[n];if(!a)return;const o=a.viewerHasReacted,i=a.heartCount;t.classList.add("is-loading");const r=o?Math.max(0,i-1):i+1,c=!o;a.heartCount=r,a.viewerHasReacted=c,updateHeartButton(n,r,c);const u=await toggleHeartReaction(userToken,a.commentId,o);if(t.classList.remove("is-loading"),u){const e=getPageConfig();e&&clearCache(e.discussionTerm)}else a.heartCount=i,a.viewerHasReacted=o,updateHeartButton(n,i,o)}async function init(){const e=getPageConfig();if(!e)return;const t=e.discussionTerm;if(isInitialized&&currentPagePath===t)return;currentPagePath=t,isInitialized=!0,initializeHeartButtons(e.imageIds);try{userToken=await getGiscusToken(),isAuthenticated=!!userToken}catch{userToken=null,isAuthenticated=!1}const n=getCache(e.discussionTerm);if(n)return applyCachedReactions(n),void(isAuthenticated&&fetchAndApplyLive(e));await fetchAndApplyLive(e)}async function fetchAndApplyLive(e){try{const t=await fetchAllComments(e.repo,e.discussionTerm,e.category);if(!t)return;if(applyReactions(t),isAuthenticated&&userToken){const e=Object.values(imageReactions).map((e=>e.commentId)).filter(Boolean);if(e.length>0){const t=await checkViewerReactions(e,userToken);for(const[e,n]of Object.entries(imageReactions))t[n.commentId]&&(n.viewerHasReacted=!0,updateHeartButton(e,n.heartCount,!0))}}setCache(e.discussionTerm,{timestamp:Date.now(),imageReactions:{...imageReactions}})}catch(e){console.warn("[masonry-reactions] Failed to fetch live data:",e)}}function cleanup(){isInitialized=!1,currentPagePath="",imageReactions={}}function onPageView(){cleanup(),requestAnimationFrame((()=>{init()}))}function tryRegisterSwup(){if(swupHooked)return!0;try{const s=eval("typeof swup !== 'undefined' ? swup : null");if(s&&s.hooks)return s.hooks.on("page:view",onPageView),swupHooked=!0,!0}catch{}return!1}if(window.addEventListener("storage",(e=>{if(e.key===GISCUS_SESSION_KEY)if(e.newValue)getGiscusToken().then((e=>{if(e){userToken=e,isAuthenticated=!0;const t=getPageConfig();t&&(clearCache(t.discussionTerm),fetchAndApplyLive(t))}}));else{userToken=null,isAuthenticated=!1;for(const[e,t]of Object.entries(imageReactions))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}})),window.addEventListener("message",(e=>{if(e.origin!==GISCUS_ORIGIN)return;const{data:t}=e;if("object"==typeof t&&t.giscus&&t.giscus.signOut){userToken=null,isAuthenticated=!1;for(const[e,t]of Object.entries(imageReactions))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}})),tryRegisterSwup(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{tryRegisterSwup(),init()})):(tryRegisterSwup(),init()),!swupHooked){let e=0;const t=setInterval((()=>{(tryRegisterSwup()||++e>=30)&&clearInterval(t)}),100)}})();
//# sourceMappingURL=masonry-reactions.js.map
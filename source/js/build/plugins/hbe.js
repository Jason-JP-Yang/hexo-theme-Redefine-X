import{main as e}from"../main.js";import{initTOC as t}from"../layouts/toc.js";import{initTocToggle as n}from"../tools/tocToggle.js";export function initHBE(){const r=window.crypto||window.msCrypto,o=window.localStorage,a="hexo-blog-encrypt:#"+window.location.pathname,c=document.getElementById("hexo-blog-encrypt"),i=c.dataset.wpm,l=c.dataset.whm,s=c.getElementsByTagName("script").hbeData,d=s.innerText,u=s.dataset.hmacdigest,y=s.dataset.keysalt||"",m=s.dataset.iv||"",h=Number.parseInt(s.dataset.kdfiter,10),p=hexToArray(y),f=hexToArray(m).buffer,g=Number.isFinite(h)?h:131071;function hexToArray(e){return new Uint8Array(e.match(/[\da-f]{2}/gi).map((e=>parseInt(e,16))))}function arrayBufferToHex(e){if("object"!=typeof e||null===e||"number"!=typeof e.byteLength)throw new TypeError("Expected input to be an ArrayBuffer");for(var t,n=new Uint8Array(e),r="",o=0;o<n.length;o++)r+=1===(t=n[o].toString(16)).length?"0"+t:t;return r}async function convertHTMLToElement(e){let t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach((async e=>{e.replaceWith(await async function getExecutableScript(e){let t=document.createElement("script");return["type","text","src","crossorigin","defer","referrerpolicy"].forEach((n=>{e[n]&&(t[n]=e[n])})),t}(e))})),t}async function decrypt(o,c,s){let y=hexToArray(d);return await r.subtle.decrypt({name:"AES-CBC",iv:c},o,y.buffer).then((async o=>{const c=(new TextDecoder).decode(o);if(!c.startsWith("<hbe-prefix></hbe-prefix>"))throw"Decode successfully but not start with KnownPrefix.";const i=document.createElement("button");i.textContent="Encrypt again",i.type="button",i.classList.add("hbe-button"),i.addEventListener("click",(()=>{window.localStorage.removeItem(a),window.location.reload()})),document.getElementById("hexo-blog-encrypt").style.display="inline",document.getElementById("hexo-blog-encrypt").innerHTML="",document.getElementById("hexo-blog-encrypt").appendChild(await convertHTMLToElement(c)),document.getElementById("hexo-blog-encrypt").appendChild(i),import("../layouts/lazyload.js").then((e=>{e.forceLoadAllPreloaders&&e.forceLoadAllPreloaders()})).catch((()=>{document.querySelectorAll(".img-preloader").forEach((e=>{if("true"!==e.dataset.loaded){const t=e.dataset.src;if(t){const n=document.createElement("img");n.src=t,n.alt=e.dataset.alt||"",e.parentNode&&e.parentNode.replaceChild(n,e)}}}))})),e.refresh(),function rebuildTOC(){const e=document.getElementById("hexo-blog-encrypt");if(!e)return;const t=e.querySelectorAll("h1, h2, h3, h4, h5, h6");if(0===t.length)return;let n=document.querySelector(".toc-content-container");if(!n){const e=document.querySelector(".post-page-container");if(!e)return;n=document.createElement("div"),n.className="toc-content-container",e.appendChild(n)}let r='<div class="post-toc-wrap"><div class="post-toc">';r+='<div class="toc-title">Catalog</div>';const o=document.querySelector(".article-title-regular")||document.querySelector(".article-title-cover"),a=o?o.innerText:document.title;r+=`<div class="page-title">${a}</div>`,r+='<ol class="nav">',t.forEach(((e,t)=>{e.id||(e.id="hbe-"+t+"-"+e.textContent.trim().replace(/\s+/g,"-"));const n=e.tagName.substring(1);r+=`\n        <li class="nav-item nav-level-${n}">\n          <a class="nav-link" href="#${e.id}">\n            <span class="nav-text">${e.textContent}</span>\n          </a>\n        </li>`})),r+="</ol></div></div>",n.innerHTML=r}(),t(),n().pageAsideHandleOfTOC(!0);var d=new Event("hexo-blog-decrypt");return window.dispatchEvent(d),await async function verifyContent(e,t){const n=(new TextEncoder).encode(t);let o=hexToArray(u);const a=await r.subtle.verify({name:"HMAC",hash:"SHA-256"},e,o,n);return console.log(`Verification result: ${a}`),a||(alert(l),console.log(`${l}, got `,o," but proved wrong.")),a}(s,c)})).catch((e=>(alert(i),console.log(e),!1)))}!function hbeLoader(){const e=JSON.parse(o.getItem(a));if(e){console.log(`Password got from localStorage(${a}): `,e);const t=e.iv?hexToArray(e.iv).buffer:null,n=e.dk,c=e.hmk;r.subtle.importKey("jwk",n,{name:"AES-CBC",length:256},!0,["decrypt"]).then((e=>{r.subtle.importKey("jwk",c,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"]).then((n=>{decrypt(e,f||t,n).then((e=>{e||o.removeItem(a)}))}))}))}c.addEventListener("keydown",(async e=>{if(e.isComposing||"Enter"===e.key){const e=document.getElementById("hbePass").value,t=await function getKeyMaterial(e){let t=new TextEncoder;return r.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveKey","deriveBits"])}(e),n=await function getHmacKey(e){return r.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:p.buffer,iterations:g},e,{name:"HMAC",hash:"SHA-256",length:256},!0,["verify"])}(t),c=await function getDecryptKey(e){return r.subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",salt:p.buffer,iterations:g},e,{name:"AES-CBC",length:256},!0,["decrypt"])}(t),i=f||await getLegacyIv(t);decrypt(c,i,n).then((e=>{console.log(`Decrypt result: ${e}`),e&&r.subtle.exportKey("jwk",c).then((e=>{r.subtle.exportKey("jwk",n).then((t=>{const n={dk:e,iv:arrayBufferToHex(i),hmk:t};o.setItem(a,JSON.stringify(n))}))}))}))}}))}()}
//# sourceMappingURL=hbe.js.map
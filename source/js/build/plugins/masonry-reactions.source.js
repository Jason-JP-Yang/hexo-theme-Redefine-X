(function(){const GISCUS_SESSION_KEY="giscus-session",GISCUS_ORIGIN="https://giscus.app",GITHUB_GRAPHQL_API="https://api.github.com/graphql",CACHE_KEY_PREFIX="masonry-reactions-cache:",CACHE_TTL=3e5,MASONRY_SCROLL_KEY="masonry-scroll-position",PENDING_HEART_KEY="masonry-pending-heart";let currentPagePath="",imageReactions={},userToken=null,isAuthenticated=!1,isInitialized=!1,swupHooked=!1;function getPageConfig(){const e=document.getElementById("masonry-reactions-data");if(!e)return null;try{return JSON.parse(e.textContent||"")}catch{return null}}function getGiscusApiBase(){const e=getPageConfig();return e?.giscusProxy||GISCUS_ORIGIN}async function getGiscusToken(){const e=localStorage.getItem(GISCUS_SESSION_KEY);if(!e)return null;let t;try{t=JSON.parse(e)}catch{return null}if(!t)return null;try{const e=getGiscusApiBase(),n=await fetch(`${e}/api/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(t)}`});if(!n.ok)return null;return(await n.json()).token||null}catch{return null}}function getGiscusLoginUrl(){const e=encodeURIComponent(location.href);return`${GISCUS_ORIGIN}/api/oauth/authorize?redirect_uri=${e}`}async function fetchFromGiscusAPI(e,t,n,a=100,i){const o=new URLSearchParams({repo:e,term:t,category:n,number:"0",strict:"false",first:String(a)});i&&o.set("after",i);try{const e=getGiscusApiBase(),t=await fetch(`${e}/api/discussions?${o}`);return t.ok?await t.json():(404===t.status||console.warn("[masonry-reactions] Giscus API error:",t.status),null)}catch(e){return console.warn("[masonry-reactions] Giscus API fetch error:",e),null}}async function fetchAllComments(e,t,n){const a=await fetchFromGiscusAPI(e,t,n,100);if(!a?.discussion)return null;const i=[...a.discussion.comments||[]];let o=a.discussion.pageInfo;for(;o?.hasNextPage&&o.endCursor;){const a=await fetchFromGiscusAPI(e,t,n,100,o.endCursor);if(!a?.discussion)break;i.push(...a.discussion.comments||[]),o=a.discussion.pageInfo}return i}async function checkViewerReactions(e,t){if(0===e.length)return{};const n={};for(let a=0;a<e.length;a+=50){const i=e.slice(a,a+50),o=i.map(((e,t)=>`c${t}: node(id: "${e}") { ... on DiscussionComment { id reactionGroups { content viewerHasReacted } } }`)).join("\n");try{const e=await fetch(GITHUB_GRAPHQL_API,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({query:`query { ${o} }`})});if(!e.ok)continue;const a=await e.json();if(a.errors)continue;for(let e=0;e<i.length;e++){const t=a.data?.[`c${e}`];if(t?.reactionGroups){const a=t.reactionGroups.find((e=>"HEART"===e.content));n[i[e]]=a?.viewerHasReacted||!1}}}catch{}}return n}async function toggleHeartReaction(e,t,n){const a=n?"remove":"add";try{return(await fetch(GITHUB_GRAPHQL_API,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({query:`mutation($content: ReactionContent!, $subjectId: ID!) {\n            toggleReaction: ${a}Reaction(input: {content: $content, subjectId: $subjectId}) {\n              reaction { content }\n            }\n          }`,variables:{content:"HEART",subjectId:t}})})).ok}catch{return!1}}function parseImageId(e){if(!e)return null;let t=e.match(/`masonry-image:(.+?)`/);return t?t[1].trim():(t=e.match(/<!--\s*masonry-image:(.+?)\s*-->/),t?t[1].trim():(t=e.match(/<!--\s*masonry-image-id:\s*(.+?)\s*-->/),t?t[1].trim():(t=e.match(/<code[^>]*>masonry-image:(.+?)<\/code>/),t?t[1].trim():null)))}function getCacheKey(e){return`${CACHE_KEY_PREFIX}${e}`}function getCache(e){try{const t=sessionStorage.getItem(getCacheKey(e));if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>CACHE_TTL?(sessionStorage.removeItem(getCacheKey(e)),null):n}catch{return null}}function setCache(e,t){try{sessionStorage.setItem(getCacheKey(e),JSON.stringify(t))}catch{}}function clearCache(e){try{sessionStorage.removeItem(getCacheKey(e))}catch{}}function createHeartButton(e){const t=document.createElement("button");return t.className="masonry-heart-btn",t.dataset.imageId=e,t.setAttribute("aria-label","Like this photo"),t.innerHTML='\n      <span class="heart-icon">\n        <i class="fa-regular fa-heart heart-outline"></i>\n        <i class="fa-solid fa-heart heart-filled"></i>\n      </span>\n      <span class="heart-count">0</span>\n    ',t.addEventListener("click",handleHeartClick),t}function initializeHeartButtons(e){const t=document.querySelectorAll(".masonry-item .image-container"),n=new Set(e);t.forEach((e=>{if(e.querySelector(".masonry-heart-btn"))return;let t="";const a=e.querySelector(".img-preloader");if(a&&(t=a.getAttribute("data-src")||""),!t){const n=e.querySelector("img");n&&(t=n.getAttribute("data-src")||n.getAttribute("src")||"")}if(!t)return;const i=findImageIdFromSrc(t,n);i&&(e.dataset.imageId=i,e.classList.contains("masonry-reactions-mode")||e.classList.add("masonry-reactions-mode"),e.appendChild(createHeartButton(i)))}))}function findImageIdFromSrc(e,t){if(!e)return null;const n=decodeURIComponent(e.split("#")[0].split("?")[0]).replace(/\.[^.\/]+$/,"");for(const e of t){const t=e.replace(/\.[^.\/]+$/,"");if(n.includes(t)||n.endsWith(t))return e}return null}function updateHeartButton(e,t,n){const a=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(e)}"]`);if(!a)return;const i=a.querySelector(".heart-count");i&&(i.textContent=String(t)),a.dataset.reacted=n?"true":"false",a.classList.toggle("is-reacted",n),a.classList.toggle("has-count",t>0)}function applyReactions(e){const t=imageReactions;imageReactions={};for(const n of e){const e=parseImageId(n.body||n.bodyHTML||"");if(!e)continue;const a=n.reactions?.HEART?.count||0,i=n.reactions?.HEART?.viewerHasReacted||!1,o=t[e]?.viewerHasReacted||i,r=imageReactions[e];r&&r.heartCount>=a||(imageReactions[e]={commentId:n.id,heartCount:a,viewerHasReacted:o},updateHeartButton(e,a,o))}}function applyCachedReactions(e){imageReactions={...e.imageReactions};for(const[e,t]of Object.entries(imageReactions))updateHeartButton(e,t.heartCount,t.viewerHasReacted)}async function handleHeartClick(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;if(t.classList.contains("is-loading"))return;if(!isAuthenticated||!userToken){sessionStorage.setItem(MASONRY_SCROLL_KEY,String(window.scrollY));const e=t.dataset.imageId;return e&&sessionStorage.setItem(PENDING_HEART_KEY,e),void(window.location.href=getGiscusLoginUrl())}const n=t.dataset.imageId,a=imageReactions[n];if(!a)return;const i=a.viewerHasReacted,o=a.heartCount;t.classList.add("is-loading");const r=i?Math.max(0,o-1):o+1,c=!i;a.heartCount=r,a.viewerHasReacted=c,updateHeartButton(n,r,c);const u=await toggleHeartReaction(userToken,a.commentId,i);if(t.classList.remove("is-loading"),u){const e=getPageConfig();e&&clearCache(e.discussionTerm)}else a.heartCount=o,a.viewerHasReacted=i,updateHeartButton(n,o,i)}async function init(){const e=getPageConfig();if(!e)return;const t=e.discussionTerm;if(isInitialized&&currentPagePath===t)return;currentPagePath=t,isInitialized=!0;const n=sessionStorage.getItem(PENDING_HEART_KEY);n&&sessionStorage.removeItem(PENDING_HEART_KEY);const a=sessionStorage.getItem(MASONRY_SCROLL_KEY);if(a&&sessionStorage.removeItem(MASONRY_SCROLL_KEY),initializeHeartButtons(e.imageIds),a){const e=parseInt(a,10);!isNaN(e)&&e>0&&requestAnimationFrame((()=>{window.scrollTo({top:e,behavior:"instant"})}))}try{userToken=await getGiscusToken(),isAuthenticated=!!userToken}catch{userToken=null,isAuthenticated=!1}const i=getCache(e.discussionTerm);if(i)return applyCachedReactions(i),isAuthenticated&&fetchAndApplyLive(e),void(n&&isAuthenticated&&handlePendingHeart(n));await fetchAndApplyLive(e),n&&isAuthenticated&&handlePendingHeart(n)}function handlePendingHeart(e){setTimeout((()=>{const t=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(e)}"]`);t&&!t.classList.contains("is-reacted")&&t.click()}),500)}async function fetchAndApplyLive(e){try{const t=await fetchAllComments(e.repo,e.discussionTerm,e.category);if(!t)return;if(applyReactions(t),isAuthenticated&&userToken){const e=Object.values(imageReactions).map((e=>e.commentId)).filter(Boolean);if(e.length>0){const t=await checkViewerReactions(e,userToken);for(const[e,n]of Object.entries(imageReactions))t[n.commentId]&&(n.viewerHasReacted=!0,updateHeartButton(e,n.heartCount,!0))}}setCache(e.discussionTerm,{timestamp:Date.now(),imageReactions:{...imageReactions}})}catch(e){console.warn("[masonry-reactions] Failed to fetch live data:",e)}}function cleanup(){isInitialized=!1,currentPagePath="",imageReactions={}}function onPageView(){cleanup(),requestAnimationFrame((()=>{init()}))}function tryRegisterSwup(){if(swupHooked)return!0;try{const s=eval("typeof swup !== 'undefined' ? swup : null");if(s&&s.hooks)return s.hooks.on("page:view",onPageView),swupHooked=!0,!0}catch{}return!1}async function refreshAuthenticatedState(){const e=await getGiscusToken();if(!e)return;userToken=e,isAuthenticated=!0;const t=getPageConfig();t&&(clearCache(t.discussionTerm),fetchAndApplyLive(t))}if(window.addEventListener("storage",(e=>{if(e.key===GISCUS_SESSION_KEY)if(e.newValue)refreshAuthenticatedState();else{userToken=null,isAuthenticated=!1;for(const[e,t]of Object.entries(imageReactions))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}})),window.addEventListener("message",(e=>{if(e.origin!==GISCUS_ORIGIN)return;const{data:t}=e;if("object"==typeof t&&t.giscus&&t.giscus.signOut){userToken=null,isAuthenticated=!1;for(const[e,t]of Object.entries(imageReactions))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}})),function syncOAuthSession(){try{const e=new URL(location.href).searchParams.get("giscus");e&&localStorage.setItem(GISCUS_SESSION_KEY,JSON.stringify(e))}catch{}}(),window.addEventListener("giscus:session-change",(()=>{refreshAuthenticatedState()})),tryRegisterSwup(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{tryRegisterSwup(),init()})):(tryRegisterSwup(),init()),!swupHooked){let e=0;const t=setInterval((()=>{(tryRegisterSwup()||++e>=30)&&clearInterval(t)}),100)}})();
//# sourceMappingURL=masonry-reactions.source.js.map
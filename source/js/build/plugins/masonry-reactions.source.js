!function(){const e="giscus-session",t="https://giscus.app",n="https://api.github.com/graphql";let o="",r={},a=null,s=!1,i=!1;function getPageConfig(){const e=document.getElementById("masonry-reactions-data");if(!e)return null;try{return JSON.parse(e.textContent||"")}catch{return null}}async function getGiscusToken(){const n=localStorage.getItem(e);if(!n)return null;let o;try{o=JSON.parse(n)}catch{return null}if(!o)return null;try{const e=await fetch(`${t}/api/oauth/token`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(o)}`});if(!e.ok)return null;return(await e.json()).token||null}catch{return null}}async function graphqlFetch(e,t,o){const r={"Content-Type":"application/json"};o&&(r.Authorization=`Bearer ${o}`);const a=await fetch(n,{method:"POST",headers:r,body:JSON.stringify({query:e,variables:t})});if(!a.ok)throw new Error(`GraphQL request failed: ${a.status}`);return a.json()}function parseImageId(e){if(!e)return null;const t=e.match(/<!-- masonry-image-id: (.+?) -->/);return t?t[1].trim():null}function getCacheKey(e){return`masonry-reactions-cache:${e}`}function clearCache(e){try{sessionStorage.removeItem(getCacheKey(e))}catch{}}function initializeHeartButtons(e){const t=document.querySelectorAll(".masonry-item .image-container"),n=new Set(e);t.forEach((e=>{if(e.querySelector(".masonry-heart-btn"))return;let t="";const o=e.querySelector(".img-preloader");if(o&&(t=o.getAttribute("data-src")||""),!t){const n=e.querySelector("img");n&&(t=n.getAttribute("data-src")||n.getAttribute("src")||"")}if(!t)return;const r=function findImageIdFromSrc(e,t){if(!e)return null;const n=decodeURIComponent(e.split("#")[0].split("?")[0]),o=n.replace(/\.[^.\/]+$/,"");for(const e of t){const t=e.replace(/\.[^.\/]+$/,"");if(o.includes(t)||o.endsWith(t))return e}return null}(t,n);if(!r)return;e.dataset.imageId=r;const a=function createHeartButton(e){const t=document.createElement("button");return t.className="masonry-heart-btn",t.dataset.imageId=e,t.setAttribute("aria-label","Like this photo"),t.innerHTML='\n      <span class="heart-icon">\n        <i class="fa-regular fa-heart heart-outline"></i>\n        <i class="fa-solid fa-heart heart-filled"></i>\n      </span>\n      <span class="heart-count">0</span>\n    ',t.addEventListener("click",handleHeartClick),t}(r);e.appendChild(a)}))}function updateHeartButton(e,t,n){const o=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(e)}"]`);if(!o)return;const r=o.querySelector(".heart-count");r&&(r.textContent=String(t)),o.dataset.reacted=n?"true":"false",o.classList.toggle("is-reacted",n),o.classList.toggle("has-count",t>0)}async function handleHeartClick(e){e.preventDefault(),e.stopPropagation();const o=e.currentTarget;if(o.classList.contains("is-loading"))return;if(!s||!a)return void(window.location.href=function getGiscusLoginUrl(){const e=encodeURIComponent(location.href);return`${t}/api/oauth/authorize?redirect_uri=${e}`}());const i=o.dataset.imageId,c=r[i];if(!c)return;const u=c.viewerHasReacted,d=c.heartCount;o.classList.add("is-loading");const l=u?Math.max(0,d-1):d+1,f=!u;c.heartCount=l,c.viewerHasReacted=f,updateHeartButton(i,l,f);const m=await async function toggleHeartReaction(e,t,o){const r=`\n      mutation($content: ReactionContent!, $subjectId: ID!) {\n        toggleReaction: ${o?"remove":"add"}Reaction(input: {content: $content, subjectId: $subjectId}) {\n          reaction { content }\n        }\n      }\n    `;try{return(await fetch(n,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({query:r,variables:{content:"HEART",subjectId:t}})})).ok}catch{return!1}}(a,c.commentId,u);if(o.classList.remove("is-loading"),m){const e=getPageConfig();e&&clearCache(e.discussionTerm)}else c.heartCount=d,c.viewerHasReacted=u,updateHeartButton(i,d,u)}async function init(){const e=getPageConfig();if(!e)return;const t=e.discussionTerm;if(i&&o===t)return;o=t,i=!0,initializeHeartButtons(e.imageIds);try{a=await getGiscusToken(),a&&(s=!0)}catch{a=null,s=!1}const n=function getCache(e){try{const t=sessionStorage.getItem(getCacheKey(e));if(!t)return null;const n=JSON.parse(t);return Date.now()-n.timestamp>3e5?(sessionStorage.removeItem(getCacheKey(e)),null):n}catch{return null}}(e.discussionTerm);if(n)return function applyCachedReactions(e){r={...e.imageReactions};for(const[e,t]of Object.entries(r))updateHeartButton(e,t.heartCount,t.viewerHasReacted)}(n),void(s&&fetchAndApplyLive(e));await fetchAndApplyLive(e)}async function fetchAndApplyLive(e){try{const t=await async function fetchDiscussionData(e,t,n){const[o,r]=e.split("/");if(!o||!r)return null;const a=`"${t}" in:title repo:${e} is:discussion`,s=await graphqlFetch("query($q: String!) {\n        search(query: $q, type: DISCUSSION, first: 5) {\n          nodes {\n            ... on Discussion {\n              id\n              number\n              title\n              comments(first: 100) {\n                totalCount\n                pageInfo { hasNextPage endCursor }\n                nodes {\n                  id\n                  body\n                  reactionGroups {\n                    content\n                    users { totalCount }\n                    viewerHasReacted\n                  }\n                }\n              }\n            }\n          }\n        }\n      }",{q:a},n);if(s.errors)return console.warn("[masonry-reactions] Search error:",s.errors),null;const i=s.data?.search?.nodes;if(!i)return null;const c=i.find((e=>e.title===t));if(!c)return null;let u=[...c.comments?.nodes||[]],d=c.comments?.pageInfo;for(;d?.hasNextPage;){const e=await graphqlFetch("query($owner: String!, $name: String!, $number: Int!, $after: String!) {\n          repository(owner: $owner, name: $name) {\n            discussion(number: $number) {\n              comments(first: 100, after: $after) {\n                pageInfo { hasNextPage endCursor }\n                nodes {\n                  id\n                  body\n                  reactionGroups {\n                    content\n                    users { totalCount }\n                    viewerHasReacted\n                  }\n                }\n              }\n            }\n          }\n        }",{owner:o,name:r,number:c.number,after:d.endCursor},n);if(e.errors)break;const t=e.data?.repository?.discussion?.comments;if(!t)break;u.push(...t.nodes||[]),d=t.pageInfo}return{discussionNumber:c.number,comments:u}}(e.repo,e.discussionTerm,a);if(!t)return;!function applyReactions(e){r={};for(const t of e){const e=parseImageId(t.body);if(!e)continue;const n=t.reactionGroups?.find((e=>"HEART"===e.content)),o=n?.users?.totalCount||0,a=n?.viewerHasReacted||!1;r[e]={commentId:t.id,heartCount:o,viewerHasReacted:a},updateHeartButton(e,o,a)}}(t.comments),function setCache(e,t){try{sessionStorage.setItem(getCacheKey(e),JSON.stringify(t))}catch{}}(e.discussionTerm,{timestamp:Date.now(),imageReactions:{...r},discussionNumber:t.discussionNumber})}catch(e){console.warn("[masonry-reactions] Failed to fetch live data:",e)}}window.addEventListener("storage",(t=>{if(t.key===e)if(t.newValue)getGiscusToken().then((e=>{if(e){a=e,s=!0;const t=getPageConfig();t&&(clearCache(t.discussionTerm),fetchAndApplyLive(t))}}));else{a=null,s=!1;for(const[e,t]of Object.entries(r))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}})),window.addEventListener("message",(e=>{if(e.origin!==t)return;const{data:n}=e;if("object"==typeof n&&n.giscus&&n.giscus.signOut){a=null,s=!1;for(const[e,t]of Object.entries(r))t.viewerHasReacted=!1,updateHeartButton(e,t.heartCount,!1);const e=getPageConfig();e&&clearCache(e.discussionTerm)}}));try{void 0!==window.swup&&window.swup.hooks.on("page:view",(function onPageView(){!function cleanup(){i=!1,o="",r={}}(),requestAnimationFrame((()=>{init()}))}))}catch{}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()}();
//# sourceMappingURL=masonry-reactions.source.js.map
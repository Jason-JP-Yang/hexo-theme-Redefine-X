!function(){const t="giscus-session",e="https://api.github.com/graphql",n=document.getElementById("masonry-reactions-data");if(!n)return;let a;try{a=JSON.parse(n.textContent||"")}catch(t){return void console.warn("[masonry-reactions] Failed to parse embedded data:",t)}if(!a||!a.imageReactions)return;const{repo:o,repoId:r,categoryId:s,discussionTerm:i,discussionNumber:c,imageReactions:u}=a,[l,d]=(o||"").split("/");let m=function loadViewerReactions(){try{const t=localStorage.getItem(getLocalStorageKey());return t?JSON.parse(t):{}}catch{return{}}}(),y=null,p=!1;function getLocalStorageKey(){return`masonry-reactions-viewer:${c}`}function saveViewerReactions(){try{localStorage.setItem(getLocalStorageKey(),JSON.stringify(m))}catch{}}function parseImageIdFromBody(t){if(!t)return null;const e=t.match(/<!-- masonry-image-id: (.+?) -->/);return e?e[1].trim():null}function initializeHeartButtons(){document.querySelectorAll(".masonry-item .image-container").forEach((t=>{const e=t.querySelector("img");if(!e)return;const n=function findImageIdFromSrc(t){if(!t)return null;const e=decodeURIComponent(t.split("#")[0].split("?")[0]);for(const t of Object.keys(u))if(e.includes(t)||e.endsWith(t))return t;return null}(e.getAttribute("src")||"");if(!n)return;t.dataset.imageId=n;const a=function createHeartButton(t){const e=u[t];if(!e)return null;const n=document.createElement("button");return n.className="masonry-heart-btn",n.dataset.imageId=t,n.dataset.commentId=e.commentId,n.dataset.reacted="false",n.disabled=!0,n.setAttribute("aria-label","Like this photo"),n.innerHTML=`\n      <span class="heart-icon">\n        <i class="fa-regular fa-heart heart-outline"></i>\n        <i class="fa-solid fa-heart heart-filled"></i>\n      </span>\n      <span class="heart-count">${e.heartCount||0}</span>\n    `,e.heartCount>0&&n.classList.add("has-count"),n.addEventListener("click",handleHeartClick),n}(n);a&&t.appendChild(a)}))}function updateHeartButton(t,e,n){const a=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(t)}"]`);if(!a)return;const o=a.querySelector(".heart-count");o&&(o.textContent=String(e)),a.dataset.reacted=n?"true":"false",a.classList.toggle("is-reacted",n),a.classList.toggle("has-count",e>0)}async function handleHeartClick(t){t.preventDefault(),t.stopPropagation();const n=t.currentTarget;if(n.disabled||n.classList.contains("is-loading"))return;if(!p||!y)return void function showLoginPrompt(){if(document.querySelector(".masonry-login-prompt"))return;const t=document.createElement("div");t.className="masonry-login-prompt",t.innerHTML='\n      <div class="masonry-login-prompt-content">\n        <i class="fa-brands fa-github"></i>\n        <span>Sign in with GitHub to like photos</span>\n        <button class="masonry-login-prompt-close" aria-label="Close">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>\n    ',document.body.appendChild(t);const e=setTimeout((()=>{t.classList.add("is-hiding"),setTimeout((()=>t.remove()),300)}),3e3);t.querySelector(".masonry-login-prompt-close")?.addEventListener("click",(()=>{clearTimeout(e),t.classList.add("is-hiding"),setTimeout((()=>t.remove()),300)})),requestAnimationFrame((()=>t.classList.add("is-visible")))}();const a=n.dataset.imageId,o=n.dataset.commentId,r="true"===n.dataset.reacted;n.classList.add("is-loading");const s=parseInt(n.querySelector(".heart-count")?.textContent||"0")||0,i=!r;updateHeartButton(a,r?Math.max(0,s-1):s+1,i);const c=await async function toggleHeartReaction(t,n,a){const o=`\n      mutation($content: ReactionContent!, $subjectId: ID!) {\n        toggleReaction: ${a?"remove":"add"}Reaction(input: {content: $content, subjectId: $subjectId}) {\n          reaction { content, id }\n        }\n      }\n    `;try{return(await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({query:o,variables:{content:"HEART",subjectId:n}})})).ok}catch(t){return console.warn("[masonry-reactions] Toggle reaction error:",t),!1}}(y,o,r);n.classList.remove("is-loading"),c?(m[o]=i,saveViewerReactions()):updateHeartButton(a,s,r)}function applyLocalViewerState(){for(const[t,e]of Object.entries(m))for(const[n,a]of Object.entries(u))if(a.commentId===t){const t=document.querySelector(`.masonry-heart-btn[data-image-id="${CSS.escape(n)}"]`);t&&e&&(t.dataset.reacted="true",t.classList.add("is-reacted"))}}async function tryAuthenticate(n=0){try{if(y=await async function getGiscusToken(){const e=localStorage.getItem(t);if(!e)return null;let n;try{n=JSON.parse(e)}catch{return null}if(!n)return null;try{const t=await fetch("https://giscus.app/api/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`session=${encodeURIComponent(n)}`});return t.ok?(await t.json()).token||null:(console.warn("[masonry-reactions] Token exchange failed:",t.status),null)}catch(t){return console.warn("[masonry-reactions] Token exchange error:",t),null}}(),y){p=!0,function enableHeartButtons(){document.querySelectorAll(".masonry-heart-btn").forEach((t=>{t.disabled=!1,t.classList.add("is-enabled")}))}();const t=await async function fetchLiveReactions(t){if(!l||!d||!c)return null;try{const n=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({query:"\n      query($owner: String!, $name: String!, $number: Int!) {\n        repository(owner: $owner, name: $name) {\n          discussion(number: $number) {\n            comments(first: 100) {\n              nodes {\n                id\n                body\n                reactionGroups {\n                  content\n                  users { totalCount }\n                  viewerHasReacted\n                }\n              }\n            }\n          }\n        }\n      }\n    ",variables:{owner:l,name:d,number:c}})});if(!n.ok)return null;const a=await n.json();return a.data?.repository?.discussion?.comments?.nodes||null}catch(t){return console.warn("[masonry-reactions] Live fetch error:",t),null}}(y);t&&function applyLiveReactions(t){for(const e of t){const t=parseImageIdFromBody(e.body);if(!t)continue;const n=e.reactionGroups?.find((t=>"HEART"===t.content));if(!n)continue;const a=n.users?.totalCount||0,o=n.viewerHasReacted||!1;u[t]&&(u[t].heartCount=a),m[e.id]=o,updateHeartButton(t,a,o)}saveViewerReactions()}(t)}else if(0===n){if(new URLSearchParams(location.search).has("giscus"))return void setTimeout((()=>tryAuthenticate(1)),2e3);applyLocalViewerState()}else applyLocalViewerState()}catch(t){console.warn("[masonry-reactions] Auth error:",t),applyLocalViewerState()}}async function init(){initializeHeartButtons(),await tryAuthenticate()}window.addEventListener("storage",(e=>{e.key===t&&e.newValue&&!p&&tryAuthenticate()})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()}();
//# sourceMappingURL=masonry-reactions.source.js.map